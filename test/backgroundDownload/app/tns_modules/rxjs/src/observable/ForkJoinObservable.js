"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var Observable_1 = require("../Observable");
var EmptyObservable_1 = require("./EmptyObservable");
var isArray_1 = require("../util/isArray");
var subscribeToResult_1 = require("../util/subscribeToResult");
var OuterSubscriber_1 = require("../OuterSubscriber");
/**
 * We need this JSDoc comment for affecting ESDoc.
 * @extends {Ignored}
 * @hide true
 */
var ForkJoinObservable = (function (_super) {
    __extends(ForkJoinObservable, _super);
    function ForkJoinObservable(sources, resultSelector) {
        var _this = _super.call(this) || this;
        _this.sources = sources;
        _this.resultSelector = resultSelector;
        return _this;
    }
    /* tslint:enable:max-line-length */
    /**
     * @param sources
     * @return {any}
     * @static true
     * @name forkJoin
     * @owner Observable
     */
    ForkJoinObservable.create = function () {
        var sources = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            sources[_i] = arguments[_i];
        }
        if (sources === null || arguments.length === 0) {
            return new EmptyObservable_1.EmptyObservable();
        }
        var resultSelector = null;
        if (typeof sources[sources.length - 1] === 'function') {
            resultSelector = sources.pop();
        }
        // if the first and only other argument besides the resultSelector is an array
        // assume it's been called with `forkJoin([obs1, obs2, obs3], resultSelector)`
        if (sources.length === 1 && isArray_1.isArray(sources[0])) {
            sources = sources[0];
        }
        if (sources.length === 0) {
            return new EmptyObservable_1.EmptyObservable();
        }
        return new ForkJoinObservable(sources, resultSelector);
    };
    ForkJoinObservable.prototype._subscribe = function (subscriber) {
        return new ForkJoinSubscriber(subscriber, this.sources, this.resultSelector);
    };
    return ForkJoinObservable;
}(Observable_1.Observable));
exports.ForkJoinObservable = ForkJoinObservable;
/**
 * We need this JSDoc comment for affecting ESDoc.
 * @ignore
 * @extends {Ignored}
 */
var ForkJoinSubscriber = (function (_super) {
    __extends(ForkJoinSubscriber, _super);
    function ForkJoinSubscriber(destination, sources, resultSelector) {
        var _this = _super.call(this, destination) || this;
        _this.sources = sources;
        _this.resultSelector = resultSelector;
        _this.completed = 0;
        _this.haveValues = 0;
        var len = sources.length;
        _this.total = len;
        _this.values = new Array(len);
        for (var i = 0; i < len; i++) {
            var source = sources[i];
            var innerSubscription = subscribeToResult_1.subscribeToResult(_this, source, null, i);
            if (innerSubscription) {
                innerSubscription.outerIndex = i;
                _this.add(innerSubscription);
            }
        }
        return _this;
    }
    ForkJoinSubscriber.prototype.notifyNext = function (outerValue, innerValue, outerIndex, innerIndex, innerSub) {
        this.values[outerIndex] = innerValue;
        if (!innerSub._hasValue) {
            innerSub._hasValue = true;
            this.haveValues++;
        }
    };
    ForkJoinSubscriber.prototype.notifyComplete = function (innerSub) {
        var destination = this.destination;
        var _a = this, haveValues = _a.haveValues, resultSelector = _a.resultSelector, values = _a.values;
        var len = values.length;
        if (!innerSub._hasValue) {
            destination.complete();
            return;
        }
        this.completed++;
        if (this.completed !== len) {
            return;
        }
        if (haveValues === len) {
            var value = resultSelector ? resultSelector.apply(this, values) : values;
            destination.next(value);
        }
        destination.complete();
    };
    return ForkJoinSubscriber;
}(OuterSubscriber_1.OuterSubscriber));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRm9ya0pvaW5PYnNlcnZhYmxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiRm9ya0pvaW5PYnNlcnZhYmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNENBQWtFO0FBR2xFLHFEQUFvRDtBQUNwRCwyQ0FBMEM7QUFFMUMsK0RBQThEO0FBQzlELHNEQUFxRDtBQUdyRDs7OztHQUlHO0FBQ0g7SUFBMkMsc0NBQWE7SUFDdEQsNEJBQW9CLE9BQTBDLEVBQzFDLGNBQTZDO1FBRGpFLFlBRUUsaUJBQU8sU0FDUjtRQUhtQixhQUFPLEdBQVAsT0FBTyxDQUFtQztRQUMxQyxvQkFBYyxHQUFkLGNBQWMsQ0FBK0I7O0lBRWpFLENBQUM7SUFvQkQsbUNBQW1DO0lBRW5DOzs7Ozs7T0FNRztJQUNJLHlCQUFNLEdBQWI7UUFBaUIsaUJBRWdEO2FBRmhELFVBRWdELEVBRmhELHFCQUVnRCxFQUZoRCxJQUVnRDtZQUZoRCw0QkFFZ0Q7O1FBQy9ELEVBQUUsQ0FBQyxDQUFDLE9BQU8sS0FBSyxJQUFJLElBQUksU0FBUyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sQ0FBQyxJQUFJLGlDQUFlLEVBQUssQ0FBQztRQUNsQyxDQUFDO1FBRUQsSUFBSSxjQUFjLEdBQW1DLElBQUksQ0FBQztRQUMxRCxFQUFFLENBQUMsQ0FBQyxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDdEQsY0FBYyxHQUFtQyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDakUsQ0FBQztRQUVELDhFQUE4RTtRQUM5RSw4RUFBOEU7UUFDOUUsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksaUJBQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEQsT0FBTyxHQUFzQyxPQUFPLENB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SyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3ZCLElBQU0sS0FBSyxHQUFHLGNBQWMsR0FBRyxjQUFjLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsR0FBRyxNQUFNLENBQUM7WUFDM0UsV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMxQixDQUFDO1FBRUQsV0FBVyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ3pCLENBQUM7SUFDSCx5QkFBQztBQUFELENBQUMsQUEzREQsQ0FBb0MsaUNBQWUsR0EyRGxEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3Vic2NyaWJhYmxlT3JQcm9taXNlIH0gZnJvbSAnLi4vT2JzZXJ2YWJsZSc7XG5pbXBvcnQgeyBTdWJzY3JpYmVyIH0gZnJvbSAnLi4vU3Vic2NyaWJlcic7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICcuLi9TdWJzY3JpcHRpb24nO1xuaW1wb3J0IHsgRW1wdHlPYnNlcnZhYmxlIH0gZnJvbSAnLi9FbXB0eU9ic2VydmFibGUnO1xuaW1wb3J0IHsgaXNBcnJheSB9IGZyb20gJy4uL3V0aWwvaXNBcnJheSc7XG5cbmltcG9ydCB7IHN1YnNjcmliZVRvUmVzdWx0IH0gZnJvbSAnLi4vdXRpbC9zdWJzY3JpYmVUb1Jlc3VsdCc7XG5pbXBvcnQgeyBPdXRlclN1YnNjcmliZXIgfSBmcm9tICcuLi9PdXRlclN1YnNjcmliZXInO1xuaW1wb3J0IHsgSW5uZXJTdWJzY3JpYmVyIH0gZnJvbSAnLi4vSW5uZXJTdWJzY3JpYmVyJztcblxuLyoqXG4gKiBXZSBuZWVkIHRoaXMgSlNEb2MgY29tbWVudCBmb3IgYWZmZWN0aW5nIEVTRG9jLlxuICogQGV4dGVuZHMge0lnbm9yZWR9XG4gKiBAaGlkZSB0cnVlXG4gKi9cbmV4cG9ydCBjbGFzcyBGb3JrSm9pbk9ic2VydmFibGU8VD4gZXh0ZW5kcyBPYnNlcnZhYmxlPFQ+IHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBzb3VyY2VzOiBBcnJheTxTdWJzY3JpYmFibGVPclByb21pc2U8YW55Pj4sXG4gICAgICAgICAgICAgIHByaXZhdGUgcmVzdWx0U2VsZWN0b3I/OiAoLi4udmFsdWVzOiBBcnJheTxhbnk+KSA9PiBUKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIC8qIHRzbGludDpkaXNhYmxlOm1heC1saW5lLWxlbmd0aCAqL1xuICBzdGF0aWMgY3JlYXRlPFQsIFQyPih2MTogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQ+LCB2MjogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQyPik6IE9ic2VydmFibGU8W1QsIFQyXT47XG4gIHN0YXRpYyBjcmVhdGU8VCwgVDIsIFQzPih2MTogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQ+LCB2MjogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQyPiwgdjM6IFN1YnNjcmliYWJsZU9yUHJvbWlzZTxUMz4pOiBPYnNlcnZhYmxlPFtULCBUMiwgVDNdPjtcbiAgc3RhdGljIGNyZWF0ZTxULCBUMiwgVDMsIFQ0Pih2MTogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQ+LCB2MjogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQyPiwgdjM6IFN1YnNjcmliYWJsZU9yUHJvbWlzZTxUMz4sIHY0OiBTdWJzY3JpYmFibGVPclByb21pc2U8VDQ+KTogT2JzZXJ2YWJsZTxbVCwgVDIsIFQzLCBUNF0+O1xuICBzdGF0aWMgY3JlYXRlPFQsIFQyLCBUMywgVDQsIFQ1Pih2MTogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQ+LCB2MjogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQyPiwgdjM6IFN1YnNjcmliYWJsZU9yUHJvbWlzZTxUMz4sIHY0OiBTdWJzY3JpYmFibGVPclByb21pc2U8VDQ+LCB2NTogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQ1Pik6IE9ic2VydmFibGU8W1QsIFQyLCBUMywgVDQsIFQ1XT47XG4gIHN0YXRpYyBjcmVhdGU8VCwgVDIsIFQzLCBUNCwgVDUsIFQ2Pih2MTogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQ+LCB2MjogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQyPiwgdjM6IFN1YnNjcmliYWJsZU9yUHJvbWlzZTxUMz4sIHY0OiBTdWJzY3JpYmFibGVPclByb21pc2U8VDQ+LCB2NTogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQ1PiwgdjY6IFN1YnNjcmliYWJsZU9yUHJvbWlzZTxUNj4pOiBPYnNlcnZhYmxlPFtULCBUMiwgVDMsIFQ0LCBUNSwgVDZdPjtcbiAgc3RhdGljIGNyZWF0ZTxULCBSPih2MTogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQ+LCBwcm9qZWN0OiAodjE6IFQpID0+IFIpOiBPYnNlcnZhYmxlPFI+O1xuICBzdGF0aWMgY3JlYXRlPFQsIFQyLCBSPih2MTogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQ+LCB2MjogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQyPiwgcHJvamVjdDogKHYxOiBULCB2MjogVDIpID0+IFIpOiBPYnNlcnZhYmxlPFI+O1xuICBzdGF0aWMgY3JlYXRlPFQsIFQyLCBUMywgUj4odjE6IFN1YnNjcmliYWJsZU9yUHJvbWlzZTxUPiwgdjI6IFN1YnNjcmliYWJsZU9yUHJvbWlzZTxUMj4sIHYzOiBTdWJzY3JpYmFibGVPclByb21pc2U8VDM+LCBwcm9qZWN0OiAodjE6IFQsIHYyOiBUMiwgdjM6IFQzKSA9PiBSKTogT2JzZXJ2YWJsZTxSPjtcbiAgc3RhdGljIGNyZWF0ZTxULCBUMiwgVDMsIFQ0LCBSPih2MTogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQ+LCB2MjogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQyPiwgdjM6IFN1YnNjcmliYWJsZU9yUHJvbWlzZTxUMz4sIHY0OiBTdWJzY3JpYmFibGVPclByb21pc2U8VDQ+LCBwcm9qZWN0OiAodjE6IFQsIHYyOiBUMiwgdjM6IFQzLCB2NDogVDQpID0+IFIpOiBPYnNlcnZhYmxlPFI+O1xuICBzdGF0aWMgY3JlYXRlPFQsIFQyLCBUMywgVDQsIFQ1LCBSPih2MTogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQ+LCB2MjogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQyPiwgdjM6IFN1YnNjcmliYWJsZU9yUHJvbWlzZTxUMz4sIHY0OiBTdWJzY3JpYmFibGVPclByb21pc2U8VDQ+LCB2NTogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQ1PiwgcHJvamVjdDogKHYxOiBULCB2MjogVDIsIHYzOiBUMywgdjQ6IFQ0LCB2NTogVDUpID0+IFIpOiBPYnNlcnZhYmxlPFI+O1xuICBzdGF0aWMgY3JlYXRlPFQsIFQyLCBUMywgVDQsIFQ1LCBUNiwgUj4odjE6IFN1YnNjcmliYWJsZU9yUHJvbWlzZTxUPiwgdjI6IFN1YnNjcmliYWJsZU9yUHJvbWlzZTxUMj4sIHYzOiBTdWJzY3JpYmFibGVPclByb21pc2U8VDM+LCB2NDogU3Vic2NyaWJhYmxlT3JQcm9taXNlPFQ0PiwgdjU6IFN1YnNjcmliYWJsZU9yUHJvbWlzZTxUNT4sIHY2OiBTdWJzY3JpYmFibGVPclByb21pc2U8VDY+LCBwcm9qZWN0OiAodjE6IFQsIHYyOiBUMiwgdjM6IFQzLCB2NDogVDQsIHY1OiBUNSwgdjY6IFQ2KSA9PiBSKTogT2JzZXJ2YWJsZTxSPjtcbiAgc3RhdGljIGNyZWF0ZTxUPihzb3VyY2VzOiBTdWJzY3JpYmFibGVPclByb21pc2U8VD5bXSk6IE9ic2VydmFibGU8VFtdPjtcbiAgc3RhdGljIGNyZWF0ZTxSPihzb3VyY2VzOiBTdWJzY3JpYmFibGVPclByb21pc2U8YW55PltdKTogT2JzZXJ2YWJsZTxSPjtcbiAgc3RhdGljIGNyZWF0ZTxULCBSPihzb3VyY2VzOiBTdWJzY3JpYmFibGVPclByb21pc2U8VD5bXSwgcHJvamVjdDogKC4uLnZhbHVlczogQXJyYXk8VD4pID0+IFIpOiBPYnNlcnZhYmxlPFI+O1xuICBzdGF0aWMgY3JlYXRlPFI+KHNvdXJjZXM6IFN1YnNjcmliYWJsZU9yUHJvbWlzZTxhbnk+W10sIHByb2plY3Q6ICguLi52YWx1ZXM6IEFycmF5PGFueT4pID0+IFIpOiBPYnNlcnZhYmxlPFI+O1xuICBzdGF0aWMgY3JlYXRlPFQ+KC4uLnNvdXJjZXM6IFN1YnNjcmliYWJsZU9yUHJvbWlzZTxUPltdKTogT2JzZXJ2YWJsZTxUW10+O1xuICBzdGF0aWMgY3JlYXRlPFI+KC4uLnNvdXJjZXM6IFN1YnNjcmliYWJsZU9yUHJvbWlzZTxhbnk+W10pOiBPYnNlcnZhYmxlPFI+O1xuICAvKiB0c2xpbnQ6ZW5hYmxlOm1heC1saW5lLWxlbmd0aCAqL1xuXG4gIC8qKlxuICAgKiBAcGFyYW0gc291cmNlc1xuICAgKiBAcmV0dXJuIHthbnl9XG4gICAqIEBzdGF0aWMgdHJ1ZVxuICAgKiBAbmFtZSBmb3JrSm9pblxuICAgKiBAb3duZXIgT2JzZXJ2YWJsZVxuICAgKi9cbiAgc3RhdGljIGNyZWF0ZTxUPiguLi5zb3VyY2VzOiBBcnJheTxTdWJzY3JpYmFibGVPclByb21pc2U8YW55PiB8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQXJyYXk8U3Vic2NyaWJhYmxlT3JQcm9taXNlPGFueT4+IHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoKC4uLnZhbHVlczogQXJyYXk8YW55PikgPT4gYW55KT4pOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICBpZiAoc291cmNlcyA9PT0gbnVsbCB8fCBhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gbmV3IEVtcHR5T2JzZXJ2YWJsZTxUPigpO1xuICAgIH1cblxuICAgIGxldCByZXN1bHRTZWxlY3RvcjogKC4uLnZhbHVlczogQXJyYXk8YW55PikgPT4gYW55ID0gbnVsbDtcbiAgICBpZiAodHlwZW9mIHNvdXJjZXNbc291cmNlcy5sZW5ndGggLSAxXSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgcmVzdWx0U2VsZWN0b3IgPSA8KC4uLnZhbHVlczogQXJyYXk8YW55PikgPT4gYW55PnNvdXJjZXMucG9wKCk7XG4gICAgfVxuXG4gICAgLy8gaWYgdGhlIGZpcnN0IGFuZCBvbmx5IG90aGVyIGFyZ3VtZW50IGJlc2lkZXMgdGhlIHJlc3VsdFNlbGVjdG9yIGlzIGFuIGFycmF5XG4gICAgLy8gYXNzdW1lIGl0J3MgYmVlbiBjYWxsZWQgd2l0aCBgZm9ya0pvaW4oW29iczEsIG9iczIsIG9iczNdLCByZXN1bHRTZWxlY3RvcilgXG4gICAgaWYgKHNvdXJjZXMubGVuZ3RoID09PSAxICYmIGlzQXJyYXkoc291cmNlc1swXSkpIHtcbiAgICAgIHNvdXJjZXMgPSA8QXJyYXk8U3Vic2NyaWJhYmxlT3JQcm9taXNlPGFueT4+PnNvdXJjZXNbMF07XG4gICAgfVxuXG4gICAgaWYgKHNvdXJjZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gbmV3IEVtcHR5T2JzZXJ2YWJsZTxUPigpO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgRm9ya0pvaW5PYnNlcnZhYmxlKDxBcnJheTxTdWJzY3JpYmFibGVPclByb21pc2U8YW55Pj4+c291cmNlcywgcmVzdWx0U2VsZWN0b3IpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9zdWJzY3JpYmUoc3Vic2NyaWJlcjogU3Vic2NyaWJlcjxhbnk+KTogU3Vic2NyaXB0aW9uIHtcbiAgICByZXR1cm4gbmV3IEZvcmtKb2luU3Vic2NyaWJlcihzdWJzY3JpYmVyLCB0aGlzLnNvdXJjZXMsIHRoaXMucmVzdWx0U2VsZWN0b3IpO1xuICB9XG59XG5cbi8qKlxuICogV2UgbmVlZCB0aGlzIEpTRG9jIGNvbW1lbnQgZm9yIGFmZmVjdGluZyBFU0RvYy5cbiAqIEBpZ25vcmVcbiAqIEBleHRlbmRzIHtJZ25vcmVkfVxuICovXG5jbGFzcyBGb3JrSm9pblN1YnNjcmliZXI8VD4gZXh0ZW5kcyBPdXRlclN1YnNjcmliZXI8VCwgVD4ge1xuICBwcml2YXRlIGNvbXBsZXRlZCA9IDA7XG4gIHByaXZhdGUgdG90YWw6IG51bWJlcjtcbiAgcHJpdmF0ZSB2YWx1ZXM6IGFueVtdO1xuICBwcml2YXRlIGhhdmVWYWx1ZXMgPSAwO1xuXG4gIGNvbnN0cnVjdG9yKGRlc3RpbmF0aW9uOiBTdWJzY3JpYmVyPFQ+LFxuICAgICAgICAgICAgICBwcml2YXRlIHNvdXJjZXM6IEFycmF5PFN1YnNjcmliYWJsZU9yUHJvbWlzZTxhbnk+PixcbiAgICAgICAgICAgICAgcHJpdmF0ZSByZXN1bHRTZWxlY3Rvcj86ICguLi52YWx1ZXM6IEFycmF5PGFueT4pID0+IFQpIHtcbiAgICBzdXBlcihkZXN0aW5hdGlvbik7XG5cbiAgICBjb25zdCBsZW4gPSBzb3VyY2VzLmxlbmd0aDtcbiAgICB0aGlzLnRvdGFsID0gbGVuO1xuICAgIHRoaXMudmFsdWVzID0gbmV3IEFycmF5KGxlbik7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICBjb25zdCBzb3VyY2UgPSBzb3VyY2VzW2ldO1xuICAgICAgY29uc3QgaW5uZXJTdWJzY3JpcHRpb24gPSBzdWJzY3JpYmVUb1Jlc3VsdCh0aGlzLCBzb3VyY2UsIG51bGwsIGkpO1xuXG4gICAgICBpZiAoaW5uZXJTdWJzY3JpcHRpb24pIHtcbiAgICAgICAgKDxhbnk+IGlubmVyU3Vic2NyaXB0aW9uKS5vdXRlckluZGV4ID0gaTtcbiAgICAgICAgdGhpcy5hZGQoaW5uZXJTdWJzY3JpcHRpb24pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG5vdGlmeU5leHQob3V0ZXJWYWx1ZTogYW55LCBpbm5lclZhbHVlOiBULFxuICAgICAgICAgICAgIG91dGVySW5kZXg6IG51bWJlciwgaW5uZXJJbmRleDogbnVtYmVyLFxuICAgICAgICAgICAgIGlubmVyU3ViOiBJbm5lclN1YnNjcmliZXI8VCwgVD4pOiB2b2lkIHtcbiAgICB0aGlzLnZhbHVlc1tvdXRlckluZGV4XSA9IGlubmVyVmFsdWU7XG4gICAgaWYgKCEoPGFueT5pbm5lclN1YikuX2hhc1ZhbHVlKSB7XG4gICAgICAoPGFueT5pbm5lclN1YikuX2hhc1ZhbHVlID0gdHJ1ZTtcbiAgICAgIHRoaXMuaGF2ZVZhbHVlcysrO1xuICAgIH1cbiAgfVxuXG4gIG5vdGlmeUNvbXBsZXRlKGlubmVyU3ViOiBJbm5lclN1YnNjcmliZXI8VCwgVD4pOiB2b2lkIHtcbiAgICBjb25zdCBkZXN0aW5hdGlvbiA9IHRoaXMuZGVzdGluYXRpb247XG4gICAgY29uc3QgeyBoYXZlVmFsdWVzLCByZXN1bHRTZWxlY3RvciwgdmFsdWVzIH0gPSB0aGlzO1xuICAgIGNvbnN0IGxlbiA9IHZhbHVlcy5sZW5ndGg7XG5cbiAgICBpZiAoISg8YW55PmlubmVyU3ViKS5faGFzVmFsdWUpIHtcbiAgICAgIGRlc3RpbmF0aW9uLmNvbXBsZXRlKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5jb21wbGV0ZWQrKztcblxuICAgIGlmICh0aGlzLmNvbXBsZXRlZCAhPT0gbGVuKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGhhdmVWYWx1ZXMgPT09IGxlbikge1xuICAgICAgY29uc3QgdmFsdWUgPSByZXN1bHRTZWxlY3RvciA/IHJlc3VsdFNlbGVjdG9yLmFwcGx5KHRoaXMsIHZhbHVlcykgOiB2YWx1ZXM7XG4gICAgICBkZXN0aW5hdGlvbi5uZXh0KHZhbHVlKTtcbiAgICB9XG5cbiAgICBkZXN0aW5hdGlvbi5jb21wbGV0ZSgpO1xuICB9XG59Il19