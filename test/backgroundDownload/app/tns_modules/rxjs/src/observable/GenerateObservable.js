"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var Observable_1 = require("../Observable");
var isScheduler_1 = require("../util/isScheduler");
var selfSelector = function (value) { return value; };
/**
 * We need this JSDoc comment for affecting ESDoc.
 * @extends {Ignored}
 * @hide true
 */
var GenerateObservable = (function (_super) {
    __extends(GenerateObservable, _super);
    function GenerateObservable(initialState, condition, iterate, resultSelector, scheduler) {
        var _this = _super.call(this) || this;
        _this.initialState = initialState;
        _this.condition = condition;
        _this.iterate = iterate;
        _this.resultSelector = resultSelector;
        _this.scheduler = scheduler;
        return _this;
    }
    GenerateObservable.create = function (initialStateOrOptions, condition, iterate, resultSelectorOrObservable, scheduler) {
        if (arguments.length == 1) {
            return new GenerateObservable(initialStateOrOptions.initialState, initialStateOrOptions.condition, initialStateOrOptions.iterate, initialStateOrOptions.resultSelector || selfSelector, initialStateOrOptions.scheduler);
        }
        if (resultSelectorOrObservable === undefined || isScheduler_1.isScheduler(resultSelectorOrObservable)) {
            return new GenerateObservable(initialStateOrOptions, condition, iterate, selfSelector, resultSelectorOrObservable);
        }
        return new GenerateObservable(initialStateOrOptions, condition, iterate, resultSelectorOrObservable, scheduler);
    };
    GenerateObservable.prototype._subscribe = function (subscriber) {
        var state = this.initialState;
        if (this.scheduler) {
            return this.scheduler.schedule(GenerateObservable.dispatch, 0, {
                subscriber: subscriber,
                iterate: this.iterate,
                condition: this.condition,
                resultSelector: this.resultSelector,
                state: state
            });
        }
        var _a = this, condition = _a.condition, resultSelector = _a.resultSelector, iterate = _a.iterate;
        do {
            if (condition) {
                var conditionResult = void 0;
                try {
                    conditionResult = condition(state);
                }
                catch (err) {
                    subscriber.error(err);
                    return;
                }
                if (!conditionResult) {
                    subscriber.complete();
                    break;
                }
            }
            var value = void 0;
            try {
                value = resultSelector(state);
            }
            catch (err) {
                subscriber.error(err);
                return;
            }
            subscriber.next(value);
            if (subscriber.closed) {
                break;
            }
            try {
                state = iterate(state);
            }
            catch (err) {
                subscriber.error(err);
                return;
            }
        } while (true);
    };
    GenerateObservable.dispatch = function (state) {
        var subscriber = state.subscriber, condition = state.condition;
        if (subscriber.closed) {
            return;
        }
        if (state.needIterate) {
            try {
                state.state = state.iterate(state.state);
            }
            catch (err) {
                subscriber.error(err);
                return;
            }
        }
        else {
            state.needIterate = true;
        }
        if (condition) {
            var conditionResult = void 0;
            try {
                conditionResult = condition(state.state);
            }
            catch (err) {
                subscriber.error(err);
                return;
            }
            if (!conditionResult) {
                subscriber.complete();
                return;
            }
            if (subscriber.closed) {
                return;
            }
        }
        var value;
        try {
            value = state.resultSelector(state.state);
        }
        catch (err) {
            subscriber.error(err);
            return;
        }
        if (subscriber.closed) {
            return;
        }
        subscriber.next(value);
        if (subscriber.closed) {
            return;
        }
        return this.schedule(state);
    };
    return GenerateObservable;
}(Observable_1.Observable));
exports.GenerateObservable = GenerateObservable;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR2VuZXJhdGVPYnNlcnZhYmxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiR2VuZXJhdGVPYnNlcnZhYmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsNENBQTRDO0FBRzVDLG1EQUFrRDtBQUVsRCxJQUFNLFlBQVksR0FBRyxVQUFJLEtBQVEsSUFBSyxPQUFBLEtBQUssRUFBTCxDQUFLLENBQUM7QUE0QzVDOzs7O0dBSUc7QUFDSDtJQUE4QyxzQ0FBYTtJQUN6RCw0QkFBb0IsWUFBZSxFQUNmLFNBQTJCLEVBQzNCLE9BQXVCLEVBQ3ZCLGNBQWdDLEVBQ2hDLFNBQXNCO1FBSjFDLFlBS0ksaUJBQU8sU0FDVjtRQU5tQixrQkFBWSxHQUFaLFlBQVksQ0FBRztRQUNmLGVBQVMsR0FBVCxTQUFTLENBQWtCO1FBQzNCLGFBQU8sR0FBUCxPQUFPLENBQWdCO1FBQ3ZCLG9CQUFjLEdBQWQsY0FBYyxDQUFrQjtRQUNoQyxlQUFTLEdBQVQsU0FBUyxDQUFhOztJQUUxQyxDQUFDO0lBNEdNLHlCQUFNLEdBQWIsVUFBb0IscUJBQWdELEVBQ2hELFNBQTRCLEVBQzVCLE9BQXdCLEVBQ3hCLDBCQUE0RCxFQUM1RCxTQUFzQjtRQUN4QyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDMUIsTUFBTSxDQUFDLElBQUksa0JBQWtCLENBQ0gscUJBQXNCLENBQUMsWUFBWSxFQUNuQyxxQkFBc0IsQ0FBQyxTQUFTLEVBQ2hDLHFCQUFzQixDQUFDLE9BQU8sRUFDOUIscUJBQXNCLENBQUMsY0FBYyxJQUFJLFlBQVksRUFDckQscUJBQXNCLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDOUQsQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLDBCQUEwQixLQUFLLFNBQVMsSUFBSSx5QkFBVyxDQUFDLDBCQUEwQixDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3hGLE1BQU0sQ0FBQyxJQUFJLGtCQUFrQixDQUN4Qixx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VSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN2QixFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUN0QixNQUFNLENBQUM7UUFDVCxDQUFDO1FBQ0QsTUFBTSxDQUFxQyxJQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25FLENBQUM7SUFDSCx5QkFBQztBQUFELENBQUMsQUE5T0QsQ0FBOEMsdUJBQVUsR0E4T3ZEO0FBOU9ZLGdEQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElTY2hlZHVsZXIgfSBmcm9tICcuLi9TY2hlZHVsZXInO1xuaW1wb3J0IHsgQWN0aW9uIH0gZnJvbSAnLi4vc2NoZWR1bGVyL0FjdGlvbic7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAnLi4vT2JzZXJ2YWJsZScgO1xuaW1wb3J0IHsgU3Vic2NyaWJlciB9IGZyb20gJy4uL1N1YnNjcmliZXInO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAnLi4vU3Vic2NyaXB0aW9uJztcbmltcG9ydCB7IGlzU2NoZWR1bGVyIH0gZnJvbSAnLi4vdXRpbC9pc1NjaGVkdWxlcic7XG5cbmNvbnN0IHNlbGZTZWxlY3RvciA9IDxUPih2YWx1ZTogVCkgPT4gdmFsdWU7XG5cbmV4cG9ydCB0eXBlIENvbmRpdGlvbkZ1bmM8Uz4gPSAoc3RhdGU6IFMpID0+IGJvb2xlYW47XG5leHBvcnQgdHlwZSBJdGVyYXRlRnVuYzxTPiA9IChzdGF0ZTogUykgPT4gUztcbmV4cG9ydCB0eXBlIFJlc3VsdEZ1bmM8UywgVD4gPSAoc3RhdGU6IFMpID0+IFQ7XG5cbmludGVyZmFjZSBTY2hlZHVsZXJTdGF0ZTxULCBTPiB7XG4gIG5lZWRJdGVyYXRlPzogYm9vbGVhbjtcbiAgc3RhdGU6IFM7XG4gIHN1YnNjcmliZXI6IFN1YnNjcmliZXI8VD47XG4gIGNvbmRpdGlvbj86IENvbmRpdGlvbkZ1bmM8Uz47XG4gIGl0ZXJhdGU6IEl0ZXJhdGVGdW5jPFM+O1xuICByZXN1bHRTZWxlY3RvcjogUmVzdWx0RnVuYzxTLCBUPjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBHZW5lcmF0ZUJhc2VPcHRpb25zPFM+IHtcbiAgLyoqXG4gICAqIEluaXRpYWwgc3RhdGUuXG4gICovXG4gIGluaXRpYWxTdGF0ZTogUztcbiAgLyoqXG4gICAqIENvbmRpdGlvbiBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgc3RhdGUgYW5kIHJldHVybnMgYm9vbGVhbi5cbiAgICogV2hlbiBpdCByZXR1cm5zIGZhbHNlLCB0aGUgZ2VuZXJhdG9yIHN0b3BzLlxuICAgKiBJZiBub3Qgc3BlY2lmaWVkLCBhIGdlbmVyYXRvciBuZXZlciBzdG9wcy5cbiAgKi9cbiAgY29uZGl0aW9uPzogQ29uZGl0aW9uRnVuYzxTPjtcbiAgLyoqXG4gICAqIEl0ZXJhdGUgZnVuY3Rpb24gdGhhdCBhY2NlcHRzIHN0YXRlIGFuZCByZXR1cm5zIG5ldyBzdGF0ZS5cbiAgICovXG4gIGl0ZXJhdGU6IEl0ZXJhdGVGdW5jPFM+O1xuICAvKipcbiAgICogSVNjaGVkdWxlciB0byB1c2UgZm9yIGdlbmVyYXRpb24gcHJvY2Vzcy5cbiAgICogQnkgZGVmYXVsdCwgYSBnZW5lcmF0b3Igc3RhcnRzIGltbWVkaWF0ZWx5LlxuICAqL1xuICBzY2hlZHVsZXI/OiBJU2NoZWR1bGVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEdlbmVyYXRlT3B0aW9uczxULCBTPiBleHRlbmRzIEdlbmVyYXRlQmFzZU9wdGlvbnM8Uz4ge1xuICAvKipcbiAgICogUmVzdWx0IHNlbGVjdGlvbiBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgc3RhdGUgYW5kIHJldHVybnMgYSB2YWx1ZSB0byBlbWl0LlxuICAgKi9cbiAgcmVzdWx0U2VsZWN0b3I6IFJlc3VsdEZ1bmM8UywgVD47XG59XG5cbi8qKlxuICogV2UgbmVlZCB0aGlzIEpTRG9jIGNvbW1lbnQgZm9yIGFmZmVjdGluZyBFU0RvYy5cbiAqIEBleHRlbmRzIHtJZ25vcmVkfVxuICogQGhpZGUgdHJ1ZVxuICovXG5leHBvcnQgY2xhc3MgR2VuZXJhdGVPYnNlcnZhYmxlPFQsIFM+IGV4dGVuZHMgT2JzZXJ2YWJsZTxUPiB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5pdGlhbFN0YXRlOiBTLFxuICAgICAgICAgICAgICBwcml2YXRlIGNvbmRpdGlvbjogQ29uZGl0aW9uRnVuYzxTPixcbiAgICAgICAgICAgICAgcHJpdmF0ZSBpdGVyYXRlOiBJdGVyYXRlRnVuYzxTPixcbiAgICAgICAgICAgICAgcHJpdmF0ZSByZXN1bHRTZWxlY3RvcjogUmVzdWx0RnVuYzxTLCBUPixcbiAgICAgICAgICAgICAgcHJpdmF0ZSBzY2hlZHVsZXI/OiBJU2NoZWR1bGVyKSB7XG4gICAgICBzdXBlcigpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlcyBhbiBvYnNlcnZhYmxlIHNlcXVlbmNlIGJ5IHJ1bm5pbmcgYSBzdGF0ZS1kcml2ZW4gbG9vcFxuICAgKiBwcm9kdWNpbmcgdGhlIHNlcXVlbmNlJ3MgZWxlbWVudHMsIHVzaW5nIHRoZSBzcGVjaWZpZWQgc2NoZWR1bGVyXG4gICAqIHRvIHNlbmQgb3V0IG9ic2VydmVyIG1lc3NhZ2VzLlxuICAgKlxuICAgKiA8aW1nIHNyYz1cIi4vaW1nL2dlbmVyYXRlLnBuZ1wiIHdpZHRoPVwiMTAwJVwiPlxuICAgKlxuICAgKiBAZXhhbXBsZSA8Y2FwdGlvbj5Qcm9kdWNlcyBzZXF1ZW5jZSBvZiAwLCAxLCAyLCAuLi4gOSwgdGhlbiBjb21wbGV0ZXMuPC9jYXB0aW9uPlxuICAgKiB2YXIgcmVzID0gUnguT2JzZXJ2YWJsZS5nZW5lcmF0ZSgwLCB4ID0+IHggPCAxMCwgeCA9PiB4ICsgMSwgeCA9PiB4KTtcbiAgICpcbiAgICogQGV4YW1wbGUgPGNhcHRpb24+VXNpbmcgYXNhcCBzY2hlZHVsZXIsIHByb2R1Y2VzIHNlcXVlbmNlIG9mIDIsIDMsIDUsIHRoZW4gY29tcGxldGVzLjwvY2FwdGlvbj5cbiAgICogdmFyIHJlcyA9IFJ4Lk9ic2VydmFibGUuZ2VuZXJhdGUoMSwgeCA9PiB4IDwgNSwgeCA9PiB4ICogMiwgeCA9PiB4ICsgMSwgUnguU2NoZWR1bGVyLmFzYXApO1xuICAgKlxuICAgKiBAc2VlIHtAbGluayBmcm9tfVxuICAgKiBAc2VlIHtAbGluayBjcmVhdGV9XG4gICAqXG4gICAqIEBwYXJhbSB7U30gaW5pdGlhbFN0YXRlIEluaXRpYWwgc3RhdGUuXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb24gKHN0YXRlOiBTKTogYm9vbGVhbn0gY29uZGl0aW9uIENvbmRpdGlvbiB0byB0ZXJtaW5hdGUgZ2VuZXJhdGlvbiAodXBvbiByZXR1cm5pbmcgZmFsc2UpLlxuICAgKiBAcGFyYW0ge2Z1bmN0aW9uIChzdGF0ZTogUyk6IFN9IGl0ZXJhdGUgSXRlcmF0aW9uIHN0ZXAgZnVuY3Rpb24uXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb24gKHN0YXRlOiBTKTogVH0gcmVzdWx0U2VsZWN0b3IgU2VsZWN0b3IgZnVuY3Rpb24gZm9yIHJlc3VsdHMgcHJvZHVjZWQgaW4gdGhlIHNlcXVlbmNlLlxuICAgKiBAcGFyYW0ge1NjaGVkdWxlcn0gW3NjaGVkdWxlcl0gQSB7QGxpbmsgSVNjaGVkdWxlcn0gb24gd2hpY2ggdG8gcnVuIHRoZSBnZW5lcmF0b3IgbG9vcC4gSWYgbm90IHByb3ZpZGVkLCBkZWZhdWx0cyB0byBlbWl0IGltbWVkaWF0ZWx5LlxuICAgKiBAcmV0dXJucyB7T2JzZXJ2YWJsZTxUPn0gVGhlIGdlbmVyYXRlZCBzZXF1ZW5jZS5cbiAgICovXG4gIHN0YXRpYyBjcmVhdGU8VCwgUz4oaW5pdGlhbFN0YXRlOiBTLFxuICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbjogQ29uZGl0aW9uRnVuYzxTPixcbiAgICAgICAgICAgICAgICAgICAgICBpdGVyYXRlOiBJdGVyYXRlRnVuYzxTPixcbiAgICAgICAgICAgICAgICAgICAgICByZXN1bHRTZWxlY3RvcjogUmVzdWx0RnVuYzxTLCBUPixcbiAgICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXI/OiBJU2NoZWR1bGVyKTogT2JzZXJ2YWJsZTxUPlxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZXMgYW4gb2JzZXJ2YWJsZSBzZXF1ZW5jZSBieSBydW5uaW5nIGEgc3RhdGUtZHJpdmVuIGxvb3BcbiAgICogcHJvZHVjaW5nIHRoZSBzZXF1ZW5jZSdzIGVsZW1lbnRzLCB1c2luZyB0aGUgc3BlY2lmaWVkIHNjaGVkdWxlclxuICAgKiB0byBzZW5kIG91dCBvYnNlcnZlciBtZXNzYWdlcy5cbiAgICogVGhlIG92ZXJsb2FkIHVzZXMgc3RhdGUgYXMgYW4gZW1pdHRlZCB2YWx1ZS5cbiAgICpcbiAgICogPGltZyBzcmM9XCIuL2ltZy9nZW5lcmF0ZS5wbmdcIiB3aWR0aD1cIjEwMCVcIj5cbiAgICpcbiAgICogQGV4YW1wbGUgPGNhcHRpb24+UHJvZHVjZXMgc2VxdWVuY2Ugb2YgMCwgMSwgMiwgLi4uIDksIHRoZW4gY29tcGxldGVzLjwvY2FwdGlvbj5cbiAgICogdmFyIHJlcyA9IFJ4Lk9ic2VydmFibGUuZ2VuZXJhdGUoMCwgeCA9PiB4IDwgMTAsIHggPT4geCArIDEpO1xuICAgKlxuICAgKiBAZXhhbXBsZSA8Y2FwdGlvbj5Vc2luZyBhc2FwIHNjaGVkdWxlciwgcHJvZHVjZXMgc2VxdWVuY2Ugb2YgMSwgMiwgNCwgdGhlbiBjb21wbGV0ZXMuPC9jYXB0aW9uPlxuICAgKiB2YXIgcmVzID0gUnguT2JzZXJ2YWJsZS5nZW5lcmF0ZSgxLCB4ID0+IHggPCA1LCB4ID0+IHggKiAyLCBSeC5TY2hlZHVsZXIuYXNhcCk7XG4gICAqXG4gICAqIEBzZWUge0BsaW5rIGZyb219XG4gICAqIEBzZWUge0BsaW5rIGNyZWF0ZX1cbiAgICpcbiAgICogQHBhcmFtIHtTfSBpbml0aWFsU3RhdGUgSW5pdGlhbCBzdGF0ZS5cbiAgICogQHBhcmFtIHtmdW5jdGlvbiAoc3RhdGU6IFMpOiBib29sZWFufSBjb25kaXRpb24gQ29uZGl0aW9uIHRvIHRlcm1pbmF0ZSBnZW5lcmF0aW9uICh1cG9uIHJldHVybmluZyBmYWxzZSkuXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb24gKHN0YXRlOiBTKTogU30gaXRlcmF0ZSBJdGVyYXRpb24gc3RlcCBmdW5jdGlvbi5cbiAgICogQHBhcmFtIHtTY2hlZHVsZXJ9IFtzY2hlZHVsZXJdIEEge0BsaW5rIElTY2hlZHVsZXJ9IG9uIHdoaWNoIHRvIHJ1biB0aGUgZ2VuZXJhdG9yIGxvb3AuIElmIG5vdCBwcm92aWRlZCwgZGVmYXVsdHMgdG8gZW1pdCBpbW1lZGlhdGVseS5cbiAgICogQHJldHVybnMge09ic2VydmFibGU8Uz59IFRoZSBnZW5lcmF0ZWQgc2VxdWVuY2UuXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlPFM+KGluaXRpYWxTdGF0ZTogUyxcbiAgICAgICAgICAgICAgICAgICBjb25kaXRpb246IENvbmRpdGlvbkZ1bmM8Uz4sXG4gICAgICAgICAgICAgICAgICAgaXRlcmF0ZTogSXRlcmF0ZUZ1bmM8Uz4sXG4gICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyPzogSVNjaGVkdWxlcik6IE9ic2VydmFibGU8Uz5cblxuICAvKipcbiAgICogR2VuZXJhdGVzIGFuIG9ic2VydmFibGUgc2VxdWVuY2UgYnkgcnVubmluZyBhIHN0YXRlLWRyaXZlbiBsb29wXG4gICAqIHByb2R1Y2luZyB0aGUgc2VxdWVuY2UncyBlbGVtZW50cywgdXNpbmcgdGhlIHNwZWNpZmllZCBzY2hlZHVsZXJcbiAgICogdG8gc2VuZCBvdXQgb2JzZXJ2ZXIgbWVzc2FnZXMuXG4gICAqIFRoZSBvdmVybG9hZCBhY2NlcHRzIG9wdGlvbnMgb2JqZWN0IHRoYXQgbWlnaHQgY29udGFpbiBpbml0aWFsIHN0YXRlLCBpdGVyYXRlLFxuICAgKiBjb25kaXRpb24gYW5kIHNjaGVkdWxlci5cbiAgICpcbiAgICogPGltZyBzcmM9XCIuL2ltZy9nZW5lcmF0ZS5wbmdcIiB3aWR0aD1cIjEwMCVcIj5cbiAgICpcbiAgICogQGV4YW1wbGUgPGNhcHRpb24+UHJvZHVjZXMgc2VxdWVuY2Ugb2YgMCwgMSwgMiwgLi4uIDksIHRoZW4gY29tcGxldGVzLjwvY2FwdGlvbj5cbiAgICogdmFyIHJlcyA9IFJ4Lk9ic2VydmFibGUuZ2VuZXJhdGUoe1xuICAgKiAgIGluaXRpYWxTdGF0ZTogMCxcbiAgICogICBjb25kaXRpb246IHggPT4geCA8IDEwLFxuICAgKiAgIGl0ZXJhdGU6IHggPT4geCArIDFcbiAgICogfSk7XG4gICAqXG4gICAqIEBzZWUge0BsaW5rIGZyb219XG4gICAqIEBzZWUge0BsaW5rIGNyZWF0ZX1cbiAgICpcbiAgICogQHBhcmFtIHtHZW5lcmF0ZUJhc2VPcHRpb25zPFM+fSBvcHRpb25zIE9iamVjdCB0aGF0IG11c3QgY29udGFpbiBpbml0aWFsU3RhdGUsIGl0ZXJhdGUgYW5kIG1pZ2h0IGNvbnRhaW4gY29uZGl0aW9uIGFuZCBzY2hlZHVsZXIuXG4gICAqIEByZXR1cm5zIHtPYnNlcnZhYmxlPFM+fSBUaGUgZ2VuZXJhdGVkIHNlcXVlbmNlLlxuICAgKi9cbiAgc3RhdGljIGNyZWF0ZTxTPihvcHRpb25zOiBHZW5lcmF0ZUJhc2VPcHRpb25zPFM+KTogT2JzZXJ2YWJsZTxTPlxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZXMgYW4gb2JzZXJ2YWJsZSBzZXF1ZW5jZSBieSBydW5uaW5nIGEgc3RhdGUtZHJpdmVuIGxvb3BcbiAgICogcHJvZHVjaW5nIHRoZSBzZXF1ZW5jZSdzIGVsZW1lbnRzLCB1c2luZyB0aGUgc3BlY2lmaWVkIHNjaGVkdWxlclxuICAgKiB0byBzZW5kIG91dCBvYnNlcnZlciBtZXNzYWdlcy5cbiAgICogVGhlIG92ZXJsb2FkIGFjY2VwdHMgb3B0aW9ucyBvYmplY3QgdGhhdCBtaWdodCBjb250YWluIGluaXRpYWwgc3RhdGUsIGl0ZXJhdGUsXG4gICAqIGNvbmRpdGlvbiwgcmVzdWx0IHNlbGVjdG9yIGFuZCBzY2hlZHVsZXIuXG4gICAqXG4gICAqIDxpbWcgc3JjPVwiLi9pbWcvZ2VuZXJhdGUucG5nXCIgd2lkdGg9XCIxMDAlXCI+XG4gICAqXG4gICAqIEBleGFtcGxlIDxjYXB0aW9uPlByb2R1Y2VzIHNlcXVlbmNlIG9mIDAsIDEsIDIsIC4uLiA5LCB0aGVuIGNvbXBsZXRlcy48L2NhcHRpb24+XG4gICAqIHZhciByZXMgPSBSeC5PYnNlcnZhYmxlLmdlbmVyYXRlKHtcbiAgICogICBpbml0aWFsU3RhdGU6IDAsXG4gICAqICAgY29uZGl0aW9uOiB4ID0+IHggPCAxMCxcbiAgICogICBpdGVyYXRlOiB4ID0+IHggKyAxLFxuICAgKiAgIHJlc3VsdFNlbGVjdG9yOiB4ID0+IHhcbiAgICogfSk7XG4gICAqXG4gICAqIEBzZWUge0BsaW5rIGZyb219XG4gICAqIEBzZWUge0BsaW5rIGNyZWF0ZX1cbiAgICpcbiAgICogQHBhcmFtIHtHZW5lcmF0ZU9wdGlvbnM8VCwgUz59IG9wdGlvbnMgT2JqZWN0IHRoYXQgbXVzdCBjb250YWluIGluaXRpYWxTdGF0ZSwgaXRlcmF0ZSwgcmVzdWx0U2VsZWN0b3IgYW5kIG1pZ2h0IGNvbnRhaW4gY29uZGl0aW9uIGFuZCBzY2hlZHVsZXIuXG4gICAqIEByZXR1cm5zIHtPYnNlcnZhYmxlPFQ+fSBUaGUgZ2VuZXJhdGVkIHNlcXVlbmNlLlxuICAgKi9cbiAgc3RhdGljIGNyZWF0ZTxULCBTPihvcHRpb25zOiBHZW5lcmF0ZU9wdGlvbnM8VCwgUz4pOiBPYnNlcnZhYmxlPFQ+XG5cbiAgc3RhdGljIGNyZWF0ZTxULCBTPihpbml0aWFsU3RhdGVPck9wdGlvbnM6IFMgfCBHZW5lcmF0ZU9wdGlvbnM8VCwgUz4sXG4gICAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uPzogQ29uZGl0aW9uRnVuYzxTPixcbiAgICAgICAgICAgICAgICAgICAgICBpdGVyYXRlPzogSXRlcmF0ZUZ1bmM8Uz4sXG4gICAgICAgICAgICAgICAgICAgICAgcmVzdWx0U2VsZWN0b3JPck9ic2VydmFibGU/OiAoUmVzdWx0RnVuYzxTLCBUPikgfCBJU2NoZWR1bGVyLFxuICAgICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlcj86IElTY2hlZHVsZXIpOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7XG4gICAgICByZXR1cm4gbmV3IEdlbmVyYXRlT2JzZXJ2YWJsZTxULCBTPihcbiAgICAgICAgKDxHZW5lcmF0ZU9wdGlvbnM8VCwgUz4+aW5pdGlhbFN0YXRlT3JPcHRpb25zKS5pbml0aWFsU3RhdGUsXG4gICAgICAgICg8R2VuZXJhdGVPcHRpb25zPFQsIFM+PmluaXRpYWxTdGF0ZU9yT3B0aW9ucykuY29uZGl0aW9uLFxuICAgICAgICAoPEdlbmVyYXRlT3B0aW9uczxULCBTPj5pbml0aWFsU3RhdGVPck9wdGlvbnMpLml0ZXJhdGUsXG4gICAgICAgICg8R2VuZXJhdGVPcHRpb25zPFQsIFM+PmluaXRpYWxTdGF0ZU9yT3B0aW9ucykucmVzdWx0U2VsZWN0b3IgfHwgc2VsZlNlbGVjdG9yLFxuICAgICAgICAoPEdlbmVyYXRlT3B0aW9uczxULCBTPj5pbml0aWFsU3RhdGVPck9wdGlvbnMpLnNjaGVkdWxlcik7XG4gICAgfVxuXG4gICAgaWYgKHJlc3VsdFNlbGVjdG9yT3JPYnNlcnZhYmxlID09PSB1bmRlZmluZWQgfHwgaXNTY2hlZHVsZXIocmVzdWx0U2VsZWN0b3JPck9ic2VydmFibGUpKSB7XG4gICAgICByZXR1cm4gbmV3IEdlbmVyYXRlT2JzZXJ2YWJsZTxULCBTPihcbiAgICAgICAgPFM+aW5pdGlhbFN0YXRlT3JPcHRpb25zLFxuICAgICAgICBjb25kaXRpb24sXG4gICAgICAgIGl0ZXJhdGUsXG4gICAgICAgIHNlbGZTZWxlY3RvcixcbiAgICAgICAgPElTY2hlZHVsZXI+cmVzdWx0U2VsZWN0b3JPck9ic2VydmFibGUpO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgR2VuZXJhdGVPYnNlcnZhYmxlPFQsIFM+KFxuICAgICAgPFM+aW5pdGlhbFN0YXRlT3JPcHRpb25zLFxuICAgICAgY29uZGl0aW9uLFxuICAgICAgaXRlcmF0ZSxcbiAgICAgIDxSZXN1bHRGdW5jPFMsIFQ+PnJlc3VsdFNlbGVjdG9yT3JPYnNlcnZhYmxlLFxuICAgICAgPElTY2hlZHVsZXI+c2NoZWR1bGVyKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfc3Vic2NyaWJlKHN1YnNjcmliZXI6IFN1YnNjcmliZXI8YW55Pik6IFN1YnNjcmlwdGlvbiB8IEZ1bmN0aW9uIHwgdm9pZCB7XG4gICAgbGV0IHN0YXRlID0gdGhpcy5pbml0aWFsU3RhdGU7XG4gICAgaWYgKHRoaXMuc2NoZWR1bGVyKSB7XG4gICAgICByZXR1cm4gdGhpcy5zY2hlZHVsZXIuc2NoZWR1bGU8U2NoZWR1bGVyU3RhdGU8VCwgUz4+KEdlbmVyYXRlT2JzZXJ2YWJsZS5kaXNwYXRjaCwgMCwge1xuICAgICAgICBzdWJzY3JpYmVyLFxuICAgICAgICBpdGVyYXRlOiB0aGlzLml0ZXJhdGUsXG4gICAgICAgIGNvbmRpdGlvbjogdGhpcy5jb25kaXRpb24sXG4gICAgICAgIHJlc3VsdFNlbGVjdG9yOiB0aGlzLnJlc3VsdFNlbGVjdG9yLFxuICAgICAgICBzdGF0ZSB9KTtcbiAgICB9XG4gICAgY29uc3QgeyBjb25kaXRpb24sIHJlc3VsdFNlbGVjdG9yLCBpdGVyYXRlIH0gPSB0aGlzO1xuICAgIGRvIHtcbiAgICAgIGlmIChjb25kaXRpb24pIHtcbiAgICAgICAgbGV0IGNvbmRpdGlvblJlc3VsdDogYm9vbGVhbjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25kaXRpb25SZXN1bHQgPSBjb25kaXRpb24oc3RhdGUpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBzdWJzY3JpYmVyLmVycm9yKGVycik7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICghY29uZGl0aW9uUmVzdWx0KSB7XG4gICAgICAgICAgc3Vic2NyaWJlci5jb21wbGV0ZSgpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBsZXQgdmFsdWU6IFQ7XG4gICAgICB0cnkge1xuICAgICAgICB2YWx1ZSA9IHJlc3VsdFNlbGVjdG9yKHN0YXRlKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBzdWJzY3JpYmVyLmVycm9yKGVycik7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHN1YnNjcmliZXIubmV4dCh2YWx1ZSk7XG4gICAgICBpZiAoc3Vic2NyaWJlci5jbG9zZWQpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICBzdGF0ZSA9IGl0ZXJhdGUoc3RhdGUpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHN1YnNjcmliZXIuZXJyb3IoZXJyKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH0gd2hpbGUgKHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgZGlzcGF0Y2g8VCwgUz4oc3RhdGU6IFNjaGVkdWxlclN0YXRlPFQsIFM+KTogU3Vic2NyaXB0aW9uIHwgdm9pZCB7XG4gICAgY29uc3QgeyBzdWJzY3JpYmVyLCBjb25kaXRpb24gfSA9IHN0YXRlO1xuICAgIGlmIChzdWJzY3JpYmVyLmNsb3NlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoc3RhdGUubmVlZEl0ZXJhdGUpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHN0YXRlLnN0YXRlID0gc3RhdGUuaXRlcmF0ZShzdGF0ZS5zdGF0ZSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgc3Vic2NyaWJlci5lcnJvcihlcnIpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHN0YXRlLm5lZWRJdGVyYXRlID0gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKGNvbmRpdGlvbikge1xuICAgICAgbGV0IGNvbmRpdGlvblJlc3VsdDogYm9vbGVhbjtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbmRpdGlvblJlc3VsdCA9IGNvbmRpdGlvbihzdGF0ZS5zdGF0ZSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgc3Vic2NyaWJlci5lcnJvcihlcnIpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoIWNvbmRpdGlvblJlc3VsdCkge1xuICAgICAgICBzdWJzY3JpYmVyLmNvbXBsZXRlKCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmIChzdWJzY3JpYmVyLmNsb3NlZCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICAgIGxldCB2YWx1ZTogVDtcbiAgICB0cnkge1xuICAgICAgdmFsdWUgPSBzdGF0ZS5yZXN1bHRTZWxlY3RvcihzdGF0ZS5zdGF0ZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBzdWJzY3JpYmVyLmVycm9yKGVycik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChzdWJzY3JpYmVyLmNsb3NlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBzdWJzY3JpYmVyLm5leHQodmFsdWUpO1xuICAgIGlmIChzdWJzY3JpYmVyLmNsb3NlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICByZXR1cm4gKDxBY3Rpb248U2NoZWR1bGVyU3RhdGU8VCwgUz4+Pjxhbnk+dGhpcykuc2NoZWR1bGUoc3RhdGUpO1xuICB9XG59XG4iXX0=