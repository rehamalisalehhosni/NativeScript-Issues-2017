"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var Subject_1 = require("../Subject");
var async_1 = require("../scheduler/async");
var Subscriber_1 = require("../Subscriber");
var isNumeric_1 = require("../util/isNumeric");
var isScheduler_1 = require("../util/isScheduler");
function windowTime(windowTimeSpan) {
    var scheduler = async_1.async;
    var windowCreationInterval = null;
    var maxWindowSize = Number.POSITIVE_INFINITY;
    if (isScheduler_1.isScheduler(arguments[3])) {
        scheduler = arguments[3];
    }
    if (isScheduler_1.isScheduler(arguments[2])) {
        scheduler = arguments[2];
    }
    else if (isNumeric_1.isNumeric(arguments[2])) {
        maxWindowSize = arguments[2];
    }
    if (isScheduler_1.isScheduler(arguments[1])) {
        scheduler = arguments[1];
    }
    else if (isNumeric_1.isNumeric(arguments[1])) {
        windowCreationInterval = arguments[1];
    }
    return this.lift(new WindowTimeOperator(windowTimeSpan, windowCreationInterval, maxWindowSize, scheduler));
}
exports.windowTime = windowTime;
var WindowTimeOperator = (function () {
    function WindowTimeOperator(windowTimeSpan, windowCreationInterval, maxWindowSize, scheduler) {
        this.windowTimeSpan = windowTimeSpan;
        this.windowCreationInterval = windowCreationInterval;
        this.maxWindowSize = maxWindowSize;
        this.scheduler = scheduler;
    }
    WindowTimeOperator.prototype.call = function (subscriber, source) {
        return source.subscribe(new WindowTimeSubscriber(subscriber, this.windowTimeSpan, this.windowCreationInterval, this.maxWindowSize, this.scheduler));
    };
    return WindowTimeOperator;
}());
var CountedSubject = (function (_super) {
    __extends(CountedSubject, _super);
    function CountedSubject() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this._numberOfNextedValues = 0;
        return _this;
    }
    CountedSubject.prototype.next = function (value) {
        this._numberOfNextedValues++;
        _super.prototype.next.call(this, value);
    };
    Object.defineProperty(CountedSubject.prototype, "numberOfNextedValues", {
        get: function () {
            return this._numberOfNextedValues;
        },
        enumerable: true,
        configurable: true
    });
    return CountedSubject;
}(Subject_1.Subject));
/**
 * We need this JSDoc comment for affecting ESDoc.
 * @ignore
 * @extends {Ignored}
 */
var WindowTimeSubscriber = (function (_super) {
    __extends(WindowTimeSubscriber, _super);
    function WindowTimeSubscriber(destination, windowTimeSpan, windowCreationInterval, maxWindowSize, scheduler) {
        var _this = _super.call(this, destination) || this;
        _this.destination = destination;
        _this.windowTimeSpan = windowTimeSpan;
        _this.windowCreationInterval = windowCreationInterval;
        _this.maxWindowSize = maxWindowSize;
        _this.scheduler = scheduler;
        _this.windows = [];
        var window = _this.openWindow();
        if (windowCreationInterval !== null && windowCreationInterval >= 0) {
            var closeState = { subscriber: _this, window: window, context: null };
            var creationState = { windowTimeSpan: windowTimeSpan, windowCreationInterval: windowCreationInterval, subscriber: _this, scheduler: scheduler };
            _this.add(scheduler.schedule(dispatchWindowClose, windowTimeSpan, closeState));
            _this.add(scheduler.schedule(dispatchWindowCreation, windowCreationInterval, creationState));
        }
        else {
            var timeSpanOnlyState = { subscriber: _this, window: window, windowTimeSpan: windowTimeSpan };
            _this.add(scheduler.schedule(dispatchWindowTimeSpanOnly, windowTimeSpan, timeSpanOnlyState));
        }
        return _this;
    }
    WindowTimeSubscriber.prototype._next = function (value) {
        var windows = this.windows;
        var len = windows.length;
        for (var i = 0; i < len; i++) {
            var window_1 = windows[i];
            if (!window_1.closed) {
                window_1.next(value);
                if (window_1.numberOfNextedValues >= this.maxWindowSize) {
                    this.closeWindow(window_1);
                }
            }
        }
    };
    WindowTimeSubscriber.prototype._error = function (err) {
        var windows = this.windows;
        while (windows.length > 0) {
            windows.shift().error(err);
        }
        this.destination.error(err);
    };
    WindowTimeSubscriber.prototype._complete = function () {
        var windows = this.windows;
        while (windows.length > 0) {
            var window_2 = windows.shift();
            if (!window_2.closed) {
                window_2.complete();
            }
        }
        this.destination.complete();
    };
    WindowTimeSubscriber.prototype.openWindow = function () {
        var window = new CountedSubject();
        this.windows.push(window);
        var destination = this.destination;
        destination.next(window);
        return window;
    };
    WindowTimeSubscriber.prototype.closeWindow = function (window) {
        window.complete();
        var windows = this.windows;
        windows.splice(windows.indexOf(window), 1);
    };
    return WindowTimeSubscriber;
}(Subscriber_1.Subscriber));
function dispatchWindowTimeSpanOnly(state) {
    var subscriber = state.subscriber, windowTimeSpan = state.windowTimeSpan, window = state.window;
    if (window) {
        subscriber.closeWindow(window);
    }
    state.window = subscriber.openWindow();
    this.schedule(state, windowTimeSpan);
}
function dispatchWindowCreation(state) {
    var windowTimeSpan = state.windowTimeSpan, subscriber = state.subscriber, scheduler = state.scheduler, windowCreationInterval = state.windowCreationInterval;
    var window = subscriber.openWindow();
    var action = this;
    var context = { action: action, subscription: null };
    var timeSpanState = { subscriber: subscriber, window: window, context: context };
    context.subscription = scheduler.schedule(dispatchWindowClose, windowTimeSpan, timeSpanState);
    action.add(context.subscription);
    action.schedule(state, windowCreationInterval);
}
function dispatchWindowClose(state) {
    var subscriber = state.subscriber, window = state.window, context = state.context;
    if (context && context.action && context.subscription) {
        context.action.remove(context.subscription);
    }
    subscriber.closeWindow(window);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2luZG93VGltZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIndpbmRvd1RpbWUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSxzQ0FBcUM7QUFFckMsNENBQTJDO0FBQzNDLDRDQUEyQztBQUczQywrQ0FBOEM7QUFDOUMsbURBQWtEO0FBd0VsRCxvQkFDOEIsY0FBc0I7SUFFbEQsSUFBSSxTQUFTLEdBQWUsYUFBSyxDQUFDO0lBQ2xDLElBQUksc0JBQXNCLEdBQVcsSUFBSSxDQUFDO0lBQzFDLElBQUksYUFBYSxHQUFXLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQztJQUVyRCxFQUFFLENBQUMsQ0FBQyx5QkFBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM5QixTQUFTLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFRCxFQUFFLENBQUMsQ0FBQyx5QkFBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM5QixTQUFTLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMscUJBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkMsYUFBYSxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQsRUFBRSxDQUFDLENBQUMseUJBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDOUIsU0FBUyxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMzQixDQUFDO0lBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLHFCQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25DLHNCQUFzQixHQUFHLFNB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QUUsQ0FBQztJQUN2QyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxjQUFjLENBQUMsQ0FBQztBQUN2QyxDQUFDO0FBRUQsZ0NBQW1FLEtBQXVCO0lBQ2hGLElBQUEscUNBQWMsRUFBRSw2QkFBVSxFQUFFLDJCQUFTLEVBQUUscURBQXNCLENBQVc7SUFDaEYsSUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ3ZDLElBQU0sTUFBTSxHQUFHLElBQUksQ0FBQztJQUNwQixJQUFJLE9BQU8sR0FBMEIsRUFBRSxNQUFNLFFBQUEsRUFBRSxZQUFZLEVBQU8sSUFBSSxFQUFFLENBQUM7SUFDekUsSUFBTSxhQUFhLEdBQWtCLEVBQUUsVUFBVSxZQUFBLEVBQUUsTUFBTSxRQUFBLEVBQUUsT0FBTyxTQUFBLEVBQUUsQ0FBQztJQUNyRSxPQUFPLENBQUMsWUFBWSxHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsbUJBQW1CLEVBQUUsY0FBYyxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBQzlGLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ2pDLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLHNCQUFzQixDQUFDLENBQUM7QUFDakQsQ0FBQztBQUVELDZCQUFnQyxLQUFvQjtJQUMxQyxJQUFBLDZCQUFVLEVBQUUscUJBQU0sRUFBRSx1QkFBTyxDQUFXO0lBQzlDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsTUFBTSxJQUFJLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1FBQ3RELE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBQ0QsVUFBVSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNqQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSVNjaGVkdWxlciB9IGZyb20gJy4uL1NjaGVkdWxlcic7XG5pbXBvcnQgeyBBY3Rpb24gfSBmcm9tICcuLi9zY2hlZHVsZXIvQWN0aW9uJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICcuLi9TdWJqZWN0JztcbmltcG9ydCB7IE9wZXJhdG9yIH0gZnJvbSAnLi4vT3BlcmF0b3InO1xuaW1wb3J0IHsgYXN5bmMgfSBmcm9tICcuLi9zY2hlZHVsZXIvYXN5bmMnO1xuaW1wb3J0IHsgU3Vic2NyaWJlciB9IGZyb20gJy4uL1N1YnNjcmliZXInO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJy4uL09ic2VydmFibGUnO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAnLi4vU3Vic2NyaXB0aW9uJztcbmltcG9ydCB7IGlzTnVtZXJpYyB9IGZyb20gJy4uL3V0aWwvaXNOdW1lcmljJztcbmltcG9ydCB7IGlzU2NoZWR1bGVyIH0gZnJvbSAnLi4vdXRpbC9pc1NjaGVkdWxlcic7XG5cbi8qKlxuICogQnJhbmNoIG91dCB0aGUgc291cmNlIE9ic2VydmFibGUgdmFsdWVzIGFzIGEgbmVzdGVkIE9ic2VydmFibGUgcGVyaW9kaWNhbGx5XG4gKiBpbiB0aW1lLlxuICpcbiAqIDxzcGFuIGNsYXNzPVwiaW5mb3JtYWxcIj5JdCdzIGxpa2Uge0BsaW5rIGJ1ZmZlclRpbWV9LCBidXQgZW1pdHMgYSBuZXN0ZWRcbiAqIE9ic2VydmFibGUgaW5zdGVhZCBvZiBhbiBhcnJheS48L3NwYW4+XG4gKlxuICogPGltZyBzcmM9XCIuL2ltZy93aW5kb3dUaW1lLnBuZ1wiIHdpZHRoPVwiMTAwJVwiPlxuICpcbiAqIFJldHVybnMgYW4gT2JzZXJ2YWJsZSB0aGF0IGVtaXRzIHdpbmRvd3Mgb2YgaXRlbXMgaXQgY29sbGVjdHMgZnJvbSB0aGUgc291cmNlXG4gKiBPYnNlcnZhYmxlLiBUaGUgb3V0cHV0IE9ic2VydmFibGUgc3RhcnRzIGEgbmV3IHdpbmRvdyBwZXJpb2RpY2FsbHksIGFzXG4gKiBkZXRlcm1pbmVkIGJ5IHRoZSBgd2luZG93Q3JlYXRpb25JbnRlcnZhbGAgYXJndW1lbnQuIEl0IGVtaXRzIGVhY2ggd2luZG93XG4gKiBhZnRlciBhIGZpeGVkIHRpbWVzcGFuLCBzcGVjaWZpZWQgYnkgdGhlIGB3aW5kb3dUaW1lU3BhbmAgYXJndW1lbnQuIFdoZW4gdGhlXG4gKiBzb3VyY2UgT2JzZXJ2YWJsZSBjb21wbGV0ZXMgb3IgZW5jb3VudGVycyBhbiBlcnJvciwgdGhlIG91dHB1dCBPYnNlcnZhYmxlXG4gKiBlbWl0cyB0aGUgY3VycmVudCB3aW5kb3cgYW5kIHByb3BhZ2F0ZXMgdGhlIG5vdGlmaWNhdGlvbiBmcm9tIHRoZSBzb3VyY2VcbiAqIE9ic2VydmFibGUuIElmIGB3aW5kb3dDcmVhdGlvbkludGVydmFsYCBpcyBub3QgcHJvdmlkZWQsIHRoZSBvdXRwdXRcbiAqIE9ic2VydmFibGUgc3RhcnRzIGEgbmV3IHdpbmRvdyB3aGVuIHRoZSBwcmV2aW91cyB3aW5kb3cgb2YgZHVyYXRpb25cbiAqIGB3aW5kb3dUaW1lU3BhbmAgY29tcGxldGVzLiBJZiBgbWF4V2luZG93Q291bnRgIGlzIHByb3ZpZGVkLCBlYWNoIHdpbmRvd1xuICogd2lsbCBlbWl0IGF0IG1vc3QgZml4ZWQgbnVtYmVyIG9mIHZhbHVlcy4gV2luZG93IHdpbGwgY29tcGxldGUgaW1tZWRpYXRlbHlcbiAqIGFmdGVyIGVtaXR0aW5nIGxhc3QgdmFsdWUgYW5kIG5leHQgb25lIHN0aWxsIHdpbGwgb3BlbiBhcyBzcGVjaWZpZWQgYnlcbiAqIGB3aW5kb3dUaW1lU3BhbmAgYW5kIGB3aW5kb3dDcmVhdGlvbkludGVydmFsYCBhcmd1bWVudHMuXG4gKlxuICogQGV4YW1wbGUgPGNhcHRpb24+SW4gZXZlcnkgd2luZG93IG9mIDEgc2Vjb25kIGVhY2gsIGVtaXQgYXQgbW9zdCAyIGNsaWNrIGV2ZW50czwvY2FwdGlvbj5cbiAqIHZhciBjbGlja3MgPSBSeC5PYnNlcnZhYmxlLmZyb21FdmVudChkb2N1bWVudCwgJ2NsaWNrJyk7XG4gKiB2YXIgcmVzdWx0ID0gY2xpY2tzLndpbmRvd1RpbWUoMTAwMClcbiAqICAgLm1hcCh3aW4gPT4gd2luLnRha2UoMikpIC8vIGVhY2ggd2luZG93IGhhcyBhdCBtb3N0IDIgZW1pc3Npb25zXG4gKiAgIC5tZXJnZUFsbCgpOyAvLyBmbGF0dGVuIHRoZSBPYnNlcnZhYmxlLW9mLU9ic2VydmFibGVzXG4gKiByZXN1bHQuc3Vic2NyaWJlKHggPT4gY29uc29sZS5sb2coeCkpO1xuICpcbiAqIEBleGFtcGxlIDxjYXB0aW9uPkV2ZXJ5IDUgc2Vjb25kcyBzdGFydCBhIHdpbmRvdyAxIHNlY29uZCBsb25nLCBhbmQgZW1pdCBhdCBtb3N0IDIgY2xpY2sgZXZlbnRzIHBlciB3aW5kb3c8L2NhcHRpb24+XG4gKiB2YXIgY2xpY2tzID0gUnguT2JzZXJ2YWJsZS5mcm9tRXZlbnQoZG9jdW1lbnQsICdjbGljaycpO1xuICogdmFyIHJlc3VsdCA9IGNsaWNrcy53aW5kb3dUaW1lKDEwMDAsIDUwMDApXG4gKiAgIC5tYXAod2luID0+IHdpbi50YWtlKDIpKSAvLyBlYWNoIHdpbmRvdyBoYXMgYXQgbW9zdCAyIGVtaXNzaW9uc1xuICogICAubWVyZ2VBbGwoKTsgLy8gZmxhdHRlbiB0aGUgT2JzZXJ2YWJsZS1vZi1PYnNlcnZhYmxlc1xuICogcmVzdWx0LnN1YnNjcmliZSh4ID0+IGNvbnNvbGUubG9nKHgpKTtcbiAqXG4gKiBAZXhhbXBsZSA8Y2FwdGlvbj5TYW1lIGFzIGV4YW1wbGUgYWJvdmUgYnV0IHdpdGggbWF4V2luZG93Q291bnQgaW5zdGVhZCBvZiB0YWtlPC9jYXB0aW9uPlxuICogdmFyIGNsaWNrcyA9IFJ4Lk9ic2VydmFibGUuZnJvbUV2ZW50KGRvY3VtZW50LCAnY2xpY2snKTtcbiAqIHZhciByZXN1bHQgPSBjbGlja3Mud2luZG93VGltZSgxMDAwLCA1MDAwLCAyKSAvLyBlYWNoIHdpbmRvdyBoYXMgc3RpbGwgYXQgbW9zdCAyIGVtaXNzaW9uc1xuICogICAubWVyZ2VBbGwoKTsgLy8gZmxhdHRlbiB0aGUgT2JzZXJ2YWJsZS1vZi1PYnNlcnZhYmxlc1xuICogcmVzdWx0LnN1YnNjcmliZSh4ID0+IGNvbnNvbGUubG9nKHgpKTtcblxuICogQHNlZSB7QGxpbmsgd2luZG93fVxuICogQHNlZSB7QGxpbmsgd2luZG93Q291bnR9XG4gKiBAc2VlIHtAbGluayB3aW5kb3dUb2dnbGV9XG4gKiBAc2VlIHtAbGluayB3aW5kb3dXaGVufVxuICogQHNlZSB7QGxpbmsgYnVmZmVyVGltZX1cbiAqXG4gKiBAcGFyYW0ge251bWJlcn0gd2luZG93VGltZVNwYW4gVGhlIGFtb3VudCBvZiB0aW1lIHRvIGZpbGwgZWFjaCB3aW5kb3cuXG4gKiBAcGFyYW0ge251bWJlcn0gW3dpbmRvd0NyZWF0aW9uSW50ZXJ2YWxdIFRoZSBpbnRlcnZhbCBhdCB3aGljaCB0byBzdGFydCBuZXdcbiAqIHdpbmRvd3MuXG4gKiBAcGFyYW0ge251bWJlcn0gW21heFdpbmRvd1NpemU9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZXSBNYXggbnVtYmVyIG9mXG4gKiB2YWx1ZXMgZWFjaCB3aW5kb3cgY2FuIGVtaXQgYmVmb3JlIGNvbXBsZXRpb24uXG4gKiBAcGFyYW0ge1NjaGVkdWxlcn0gW3NjaGVkdWxlcj1hc3luY10gVGhlIHNjaGVkdWxlciBvbiB3aGljaCB0byBzY2hlZHVsZSB0aGVcbiAqIGludGVydmFscyB0aGF0IGRldGVybWluZSB3aW5kb3cgYm91bmRhcmllcy5cbiAqIEByZXR1cm4ge09ic2VydmFibGU8T2JzZXJ2YWJsZTxUPj59IEFuIG9ic2VydmFibGUgb2Ygd2luZG93cywgd2hpY2ggaW4gdHVyblxuICogYXJlIE9ic2VydmFibGVzLlxuICogQG1ldGhvZCB3aW5kb3dUaW1lXG4gKiBAb3duZXIgT2JzZXJ2YWJsZVxuICovXG5leHBvcnQgZnVuY3Rpb24gd2luZG93VGltZTxUPih0aGlzOiBPYnNlcnZhYmxlPFQ+LCB3aW5kb3dUaW1lU3BhbjogbnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyPzogSVNjaGVkdWxlcik6IE9ic2VydmFibGU8T2JzZXJ2YWJsZTxUPj47XG5leHBvcnQgZnVuY3Rpb24gd2luZG93VGltZTxUPih0aGlzOiBPYnNlcnZhYmxlPFQ+LCB3aW5kb3dUaW1lU3BhbjogbnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Q3JlYXRpb25JbnRlcnZhbDogbnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyPzogSVNjaGVkdWxlcik6IE9ic2VydmFibGU8T2JzZXJ2YWJsZTxUPj47XG5leHBvcnQgZnVuY3Rpb24gd2luZG93VGltZTxUPih0aGlzOiBPYnNlcnZhYmxlPFQ+LCB3aW5kb3dUaW1lU3BhbjogbnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Q3JlYXRpb25JbnRlcnZhbDogbnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4V2luZG93U2l6ZTogbnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyPzogSVNjaGVkdWxlcik6IE9ic2VydmFibGU8T2JzZXJ2YWJsZTxUPj47XG5cbmV4cG9ydCBmdW5jdGlvbiB3aW5kb3dUaW1lPFQ+KHRoaXM6IE9ic2VydmFibGU8VD4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3dUaW1lU3BhbjogbnVtYmVyKTogT2JzZXJ2YWJsZTxPYnNlcnZhYmxlPFQ+PiB7XG5cbiAgbGV0IHNjaGVkdWxlcjogSVNjaGVkdWxlciA9IGFzeW5jO1xuICBsZXQgd2luZG93Q3JlYXRpb25JbnRlcnZhbDogbnVtYmVyID0gbnVsbDtcbiAgbGV0IG1heFdpbmRvd1NpemU6IG51bWJlciA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTtcblxuICBpZiAoaXNTY2hlZHVsZXIoYXJndW1lbnRzWzNdKSkge1xuICAgIHNjaGVkdWxlciA9IGFyZ3VtZW50c1szXTtcbiAgfVxuXG4gIGlmIChpc1NjaGVkdWxlcihhcmd1bWVudHNbMl0pKSB7XG4gICAgc2NoZWR1bGVyID0gYXJndW1lbnRzWzJdO1xuICB9IGVsc2UgaWYgKGlzTnVtZXJpYyhhcmd1bWVudHNbMl0pKSB7XG4gICAgbWF4V2luZG93U2l6ZSA9IGFyZ3VtZW50c1syXTtcbiAgfVxuXG4gIGlmIChpc1NjaGVkdWxlcihhcmd1bWVudHNbMV0pKSB7XG4gICAgc2NoZWR1bGVyID0gYXJndW1lbnRzWzFdO1xuICB9IGVsc2UgaWYgKGlzTnVtZXJpYyhhcmd1bWVudHNbMV0pKSB7XG4gICAgd2luZG93Q3JlYXRpb25JbnRlcnZhbCA9IGFyZ3VtZW50c1sxXTtcbiAgfVxuXG4gIHJldHVybiB0aGlzLmxpZnQobmV3IFdpbmRvd1RpbWVPcGVyYXRvcjxUPih3aW5kb3dUaW1lU3Bhbiwgd2luZG93Q3JlYXRpb25JbnRlcnZhbCwgbWF4V2luZG93U2l6ZSwgc2NoZWR1bGVyKSk7XG59XG5cbmNsYXNzIFdpbmRvd1RpbWVPcGVyYXRvcjxUPiBpbXBsZW1lbnRzIE9wZXJhdG9yPFQsIE9ic2VydmFibGU8VD4+IHtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHdpbmRvd1RpbWVTcGFuOiBudW1iZXIsXG4gICAgICAgICAgICAgIHByaXZhdGUgd2luZG93Q3JlYXRpb25JbnRlcnZhbDogbnVtYmVyIHwgbnVsbCxcbiAgICAgICAgICAgICAgcHJpdmF0ZSBtYXhXaW5kb3dTaXplOiBudW1iZXIsXG4gICAgICAgICAgICAgIHByaXZhdGUgc2NoZWR1bGVyOiBJU2NoZWR1bGVyKSB7XG4gIH1cblxuICBjYWxsKHN1YnNjcmliZXI6IFN1YnNjcmliZXI8T2JzZXJ2YWJsZTxUPj4sIHNvdXJjZTogYW55KTogYW55IHtcbiAgICByZXR1cm4gc291cmNlLnN1YnNjcmliZShuZXcgV2luZG93VGltZVN1YnNjcmliZXIoXG4gICAgICBzdWJzY3JpYmVyLCB0aGlzLndpbmRvd1RpbWVTcGFuLCB0aGlzLndpbmRvd0NyZWF0aW9uSW50ZXJ2YWwsIHRoaXMubWF4V2luZG93U2l6ZSwgdGhpcy5zY2hlZHVsZXJcbiAgICApKTtcbiAgfVxufVxuXG5pbnRlcmZhY2UgQ3JlYXRpb25TdGF0ZTxUPiB7XG4gIHdpbmRvd1RpbWVTcGFuOiBudW1iZXI7XG4gIHdpbmRvd0NyZWF0aW9uSW50ZXJ2YWw6IG51bWJlcjtcbiAgc3Vic2NyaWJlcjogV2luZG93VGltZVN1YnNjcmliZXI8VD47XG4gIHNjaGVkdWxlcjogSVNjaGVkdWxlcjtcbn1cblxuaW50ZXJmYWNlIFRpbWVTcGFuT25seVN0YXRlPFQ+IHtcbiAgICB3aW5kb3c6IENvdW50ZWRTdWJqZWN0PFQ+O1xuICAgIHdpbmRvd1RpbWVTcGFuOiBudW1iZXI7XG4gICAgc3Vic2NyaWJlcjogV2luZG93VGltZVN1YnNjcmliZXI8VD47XG4gIH1cblxuaW50ZXJmYWNlIENsb3NlV2luZG93Q29udGV4dDxUPiB7XG4gIGFjdGlvbjogQWN0aW9uPENyZWF0aW9uU3RhdGU8VD4+O1xuICBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbn1cblxuaW50ZXJmYWNlIENsb3NlU3RhdGU8VD4ge1xuICBzdWJzY3JpYmVyOiBXaW5kb3dUaW1lU3Vic2NyaWJlcjxUPjtcbiAgd2luZG93OiBDb3VudGVkU3ViamVjdDxUPjtcbiAgY29udGV4dDogQ2xvc2VXaW5kb3dDb250ZXh0PFQ+O1xufVxuXG5jbGFzcyBDb3VudGVkU3ViamVjdDxUPiBleHRlbmRzIFN1YmplY3Q8VD4ge1xuICBwcml2YXRlIF9udW1iZXJPZk5leHRlZFZhbHVlczogbnVtYmVyID0gMDtcblxuICBuZXh0KHZhbHVlPzogVCk6IHZvaWQge1xuICAgIHRoaXMuX251bWJlck9mTmV4dGVkVmFsdWVzKys7XG4gICAgc3VwZXIubmV4dCh2YWx1ZSk7XG4gIH1cblxuICBnZXQgbnVtYmVyT2ZOZXh0ZWRWYWx1ZXMoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fbnVtYmVyT2ZOZXh0ZWRWYWx1ZXM7XG4gIH1cbn1cblxuLyoqXG4gKiBXZSBuZWVkIHRoaXMgSlNEb2MgY29tbWVudCBmb3IgYWZmZWN0aW5nIEVTRG9jLlxuICogQGlnbm9yZVxuICogQGV4dGVuZHMge0lnbm9yZWR9XG4gKi9cbmNsYXNzIFdpbmRvd1RpbWVTdWJzY3JpYmVyPFQ+IGV4dGVuZHMgU3Vic2NyaWJlcjxUPiB7XG4gIHByaXZhdGUgd2luZG93czogQ291bnRlZFN1YmplY3Q8VD5bXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBkZXN0aW5hdGlvbjogU3Vic2NyaWJlcjxPYnNlcnZhYmxlPFQ+PixcbiAgICAgICAgICAgICAgcHJpdmF0ZSB3aW5kb3dUaW1lU3BhbjogbnVtYmVyLFxuICAgICAgICAgICAgICBwcml2YXRlIHdpbmRvd0NyZWF0aW9uSW50ZXJ2YWw6IG51bWJlciB8IG51bGwsXG4gICAgICAgICAgICAgIHByaXZhdGUgbWF4V2luZG93U2l6ZTogbnVtYmVyLFxuICAgICAgICAgICAgICBwcml2YXRlIHNjaGVkdWxlcjogSVNjaGVkdWxlcikge1xuICAgIHN1cGVyKGRlc3RpbmF0aW9uKTtcblxuICAgIGNvbnN0IHdpbmRvdyA9IHRoaXMub3BlbldpbmRvdygpO1xuICAgIGlmICh3aW5kb3dDcmVhdGlvbkludGVydmFsICE9PSBudWxsICYmIHdpbmRvd0NyZWF0aW9uSW50ZXJ2YWwgPj0gMCkge1xuICAgICAgY29uc3QgY2xvc2VTdGF0ZTogQ2xvc2VTdGF0ZTxUPiA9IHsgc3Vic2NyaWJlcjogdGhpcywgd2luZG93LCBjb250ZXh0OiA8YW55Pm51bGwgfTtcbiAgICAgIGNvbnN0IGNyZWF0aW9uU3RhdGU6IENyZWF0aW9uU3RhdGU8VD4gPSB7IHdpbmRvd1RpbWVTcGFuLCB3aW5kb3dDcmVhdGlvbkludGVydmFsLCBzdWJzY3JpYmVyOiB0aGlzLCBzY2hlZHVsZXIgfTtcbiAgICAgIHRoaXMuYWRkKHNjaGVkdWxlci5zY2hlZHVsZShkaXNwYXRjaFdpbmRvd0Nsb3NlLCB3aW5kb3dUaW1lU3BhbiwgY2xvc2VTdGF0ZSkpO1xuICAgICAgdGhpcy5hZGQoc2NoZWR1bGVyLnNjaGVkdWxlKGRpc3BhdGNoV2luZG93Q3JlYXRpb24sIHdpbmRvd0NyZWF0aW9uSW50ZXJ2YWwsIGNyZWF0aW9uU3RhdGUpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgdGltZVNwYW5Pbmx5U3RhdGU6IFRpbWVTcGFuT25seVN0YXRlPFQ+ID0geyBzdWJzY3JpYmVyOiB0aGlzLCB3aW5kb3csIHdpbmRvd1RpbWVTcGFuIH07XG4gICAgICB0aGlzLmFkZChzY2hlZHVsZXIuc2NoZWR1bGUoZGlzcGF0Y2hXaW5kb3dUaW1lU3Bhbk9ubHksIHdpbmRvd1RpbWVTcGFuLCB0aW1lU3Bhbk9ubHlTdGF0ZSkpO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBfbmV4dCh2YWx1ZTogVCk6IHZvaWQge1xuICAgIGNvbnN0IHdpbmRvd3MgPSB0aGlzLndpbmRvd3M7XG4gICAgY29uc3QgbGVuID0gd2luZG93cy5sZW5ndGg7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykge1xuICAgICAgY29uc3Qgd2luZG93ID0gd2luZG93c1tpXTtcbiAgICAgIGlmICghd2luZG93LmNsb3NlZCkge1xuICAgICAgICB3aW5kb3cubmV4dCh2YWx1ZSk7XG4gICAgICAgIGlmICh3aW5kb3cubnVtYmVyT2ZOZXh0ZWRWYWx1ZXMgPj0gdGhpcy5tYXhXaW5kb3dTaXplKSB7XG4gICAgICAgICAgdGhpcy5jbG9zZVdpbmRvdyh3aW5kb3cpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIF9lcnJvcihlcnI6IGFueSk6IHZvaWQge1xuICAgIGNvbnN0IHdpbmRvd3MgPSB0aGlzLndpbmRvd3M7XG4gICAgd2hpbGUgKHdpbmRvd3MubGVuZ3RoID4gMCkge1xuICAgICAgd2luZG93cy5zaGlmdCgpLmVycm9yKGVycik7XG4gICAgfVxuICAgIHRoaXMuZGVzdGluYXRpb24uZXJyb3IoZXJyKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfY29tcGxldGUoKTogdm9pZCB7XG4gICAgY29uc3Qgd2luZG93cyA9IHRoaXMud2luZG93cztcbiAgICB3aGlsZSAod2luZG93cy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCB3aW5kb3cgPSB3aW5kb3dzLnNoaWZ0KCk7XG4gICAgICBpZiAoIXdpbmRvdy5jbG9zZWQpIHtcbiAgICAgICAgd2luZG93LmNvbXBsZXRlKCk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuZGVzdGluYXRpb24uY29tcGxldGUoKTtcbiAgfVxuXG4gIHB1YmxpYyBvcGVuV2luZG93KCk6IENvdW50ZWRTdWJqZWN0PFQ+IHtcbiAgICBjb25zdCB3aW5kb3cgPSBuZXcgQ291bnRlZFN1YmplY3Q8VD4oKTtcbiAgICB0aGlzLndpbmRvd3MucHVzaCh3aW5kb3cpO1xuICAgIGNvbnN0IGRlc3RpbmF0aW9uID0gdGhpcy5kZXN0aW5hdGlvbjtcbiAgICBkZXN0aW5hdGlvbi5uZXh0KHdpbmRvdyk7XG4gICAgcmV0dXJuIHdpbmRvdztcbiAgfVxuXG4gIHB1YmxpYyBjbG9zZVdpbmRvdyh3aW5kb3c6IENvdW50ZWRTdWJqZWN0PFQ+KTogdm9pZCB7XG4gICAgd2luZG93LmNvbXBsZXRlKCk7XG4gICAgY29uc3Qgd2luZG93cyA9IHRoaXMud2luZG93cztcbiAgICB3aW5kb3dzLnNwbGljZSh3aW5kb3dzLmluZGV4T2Yod2luZG93KSwgMSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZGlzcGF0Y2hXaW5kb3dUaW1lU3Bhbk9ubHk8VD4odGhpczogQWN0aW9uPFRpbWVTcGFuT25seVN0YXRlPFQ+Piwgc3RhdGU6IFRpbWVTcGFuT25seVN0YXRlPFQ+KTogdm9pZCB7XG4gIGNvbnN0IHsgc3Vic2NyaWJlciwgd2luZG93VGltZVNwYW4sIHdpbmRvdyB9ID0gc3RhdGU7XG4gIGlmICh3aW5kb3cpIHtcbiAgICBzdWJzY3JpYmVyLmNsb3NlV2luZG93KHdpbmRvdyk7XG4gIH1cbiAgc3RhdGUud2luZG93ID0gc3Vic2NyaWJlci5vcGVuV2luZG93KCk7XG4gIHRoaXMuc2NoZWR1bGUoc3RhdGUsIHdpbmRvd1RpbWVTcGFuKTtcbn1cblxuZnVuY3Rpb24gZGlzcGF0Y2hXaW5kb3dDcmVhdGlvbjxUPih0aGlzOiBBY3Rpb248Q3JlYXRpb25TdGF0ZTxUPj4sIHN0YXRlOiBDcmVhdGlvblN0YXRlPFQ+KTogdm9pZCB7XG4gIGNvbnN0IHsgd2luZG93VGltZVNwYW4sIHN1YnNjcmliZXIsIHNjaGVkdWxlciwgd2luZG93Q3JlYXRpb25JbnRlcnZhbCB9ID0gc3RhdGU7XG4gIGNvbnN0IHdpbmRvdyA9IHN1YnNjcmliZXIub3BlbldpbmRvdygpO1xuICBjb25zdCBhY3Rpb24gPSB0aGlzO1xuICBsZXQgY29udGV4dDogQ2xvc2VXaW5kb3dDb250ZXh0PFQ+ID0geyBhY3Rpb24sIHN1YnNjcmlwdGlvbjogPGFueT5udWxsIH07XG4gIGNvbnN0IHRpbWVTcGFuU3RhdGU6IENsb3NlU3RhdGU8VD4gPSB7IHN1YnNjcmliZXIsIHdpbmRvdywgY29udGV4dCB9O1xuICBjb250ZXh0LnN1YnNjcmlwdGlvbiA9IHNjaGVkdWxlci5zY2hlZHVsZShkaXNwYXRjaFdpbmRvd0Nsb3NlLCB3aW5kb3dUaW1lU3BhbiwgdGltZVNwYW5TdGF0ZSk7XG4gIGFjdGlvbi5hZGQoY29udGV4dC5zdWJzY3JpcHRpb24pO1xuICBhY3Rpb24uc2NoZWR1bGUoc3RhdGUsIHdpbmRvd0NyZWF0aW9uSW50ZXJ2YWwpO1xufVxuXG5mdW5jdGlvbiBkaXNwYXRjaFdpbmRvd0Nsb3NlPFQ+KHN0YXRlOiBDbG9zZVN0YXRlPFQ+KTogdm9pZCB7XG4gIGNvbnN0IHsgc3Vic2NyaWJlciwgd2luZG93LCBjb250ZXh0IH0gPSBzdGF0ZTtcbiAgaWYgKGNvbnRleHQgJiYgY29udGV4dC5hY3Rpb24gJiYgY29udGV4dC5zdWJzY3JpcHRpb24pIHtcbiAgICBjb250ZXh0LmFjdGlvbi5yZW1vdmUoY29udGV4dC5zdWJzY3JpcHRpb24pO1xuICB9XG4gIHN1YnNjcmliZXIuY2xvc2VXaW5kb3cod2luZG93KTtcbn1cbiJdfQ==